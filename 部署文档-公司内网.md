# ZWY项目管理系统 - 公司内网部署文档

## 环境要求
- Python 3.11+
- Node.js 16+
- Nginx 1.28.0

## 部署路径
- 项目路径：`D:\web_zwy`
- Nginx路径：`D:\nginx-1.28.0`

## 内网访问信息
- **内网服务器IP**: 10.13.33.52
- **内网访问地址**: http://10.13.33.52/

## 1. Nginx配置

### 1.1 创建配置文件
编辑文件：`D:\nginx-1.28.0\conf\nginx.conf`

```nginx
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost 10.13.33.52;

        # 前端静态文件
        location / {
            root   D:/web_zwy/backend/static;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }

        # 后端API代理
        location /api/ {
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 直接API访问（无/api前缀）
        location ~ ^/(token|users|rooms|quality-issues|communications|admin)/ {
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /docs {
            proxy_pass http://127.0.0.1:8000;
        }
    }
}
```

## 2. 部署命令

### 2.1 第一步：构建前端
```cmd
cd /d D:\web_zwy
cd frontend
npm install
npm run build
```

### 2.2 第二步：复制前端文件到后端
```cmd
xcopy /E /Y dist\* ..\backend\static\
```

### 2.3 第三步：初始化后端
```cmd
cd ..\backend
pip install -r requirements.txt
python init_db.py
```

### 2.4 第四步：启动后端服务（开新命令行窗口）
```cmd
cd /d D:\web_zwy\backend
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 2.5 第五步：启动Nginx（开新命令行窗口）
```cmd
cd /d D:\nginx-1.28.0
nginx.exe
```

## 3. 系统访问

### 3.1 本机访问
- **系统主页**: http://localhost
- **API文档**: http://localhost/docs
- **管理后台**: http://localhost/admin

### 3.2 内网访问（其他电脑）
- **系统主页**: http://10.13.33.52
- **API文档**: http://10.13.33.52/docs
- **管理后台**: http://10.13.33.52/admin

### 3.3 防火墙设置
确保Windows防火墙允许80端口入站连接：

```cmd
REM 以管理员身份运行命令提示符
netsh advfirewall firewall add rule name="Allow Port 80" dir=in action=allow protocol=TCP localport=80
```

## 4. 默认账号

| 角色 | 用户名 | 密码 |
|------|--------|------|
| 管理员 | admin | admin123 |

## 5. 停止服务

### 5.1 停止Nginx
```cmd
cd /d D:\nginx-1.28.0
nginx.exe -s quit
```

### 5.2 停止后端
在后端服务命令行窗口按 `Ctrl+C`

## 6. 重启服务

### 6.1 重启后端（如果代码有更新）
```cmd
cd /d D:\web_zwy\backend
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 6.2 重启Nginx
```cmd
cd /d D:\nginx-1.28.0
nginx.exe -s reload
```

## 7. 故障排除

### 7.1 检查端口占用
```cmd
netstat -ano | findstr :8000
netstat -ano | findstr :80
```

### 7.2 强制停止进程
```cmd
taskkill /f /pid [进程ID]
```

### 7.3 检查Nginx配置
```cmd
cd /d D:\nginx-1.28.0
nginx.exe -t
```

### 7.4 网络连通性测试
在其他电脑上测试内网访问：

```cmd
REM 测试网络连通性
ping 10.13.33.52

REM 测试80端口是否开放
telnet 10.13.33.52 80
```

### 7.5 查看Nginx错误日志
```cmd
cd /d D:\nginx-1.28.0\logs
type error.log
type access.log
```

### 7.6 常见问题解决

**问题1**: 内网其他电脑无法访问
- 检查Windows防火墙是否开放80端口
- 确认IP地址 10.13.33.52 是否正确
- 检查Nginx是否正常启动

**问题2**: 502 Bad Gateway错误
- 检查后端服务是否启动（端口8000）
- 确认后端服务绑定到 0.0.0.0:8000 而不是 127.0.0.1:8000

**问题3**: 403 Forbidden错误
- 检查静态文件路径是否正确
- 确认 backend/static 目录下有 index.html 文件

## 8. 完整重新部署流程

如果需要完全重新部署：

```cmd
REM 1. 停止服务
cd /d D:\nginx-1.28.0
nginx.exe -s quit

REM 2. 清理并重新构建
cd /d D:\web_zwy
rmdir /s /q backend\static
mkdir backend\static

REM 3. 构建前端
cd frontend
npm run build
xcopy /E /Y dist\* ..\backend\static\

REM 4. 重置数据库（可选）
cd ..\backend
del zwy_project.db
python init_db.py

REM 5. 启动服务（分别在新窗口运行）
REM 窗口1：
cd /d D:\web_zwy\backend
uvicorn main:app --host 0.0.0.0 --port 8000

REM 窗口2：
cd /d D:\nginx-1.28.0
nginx.exe
```

## 9. 部署验证清单

### 9.1 本机验证
- [ ] 访问 http://localhost 能正常加载页面
- [ ] 使用 admin/admin123 能正常登录
- [ ] API文档 http://localhost/docs 可以访问

### 9.2 内网验证
- [ ] 其他电脑访问 http://10.13.33.52 能正常加载
- [ ] 其他电脑能正常登录和使用系统功能
- [ ] 防火墙规则已正确配置

### 9.3 功能验证
- [ ] 房间管理功能正常
- [ ] 质量问题管理正常  
- [ ] 用户认证和权限正常
- [ ] 数据导出功能正常

---

## 10. 快速部署方案

### 10.1 一键部署说明

**部署分为两个阶段：**

**第一阶段**：执行 `deploy.bat` 自动完成环境准备
- 构建前端代码
- 复制静态文件  
- 安装后端依赖
- 初始化数据库
- 配置防火墙

**第二阶段**：手动启动两个服务
- 启动后端API服务（端口8000）
- 启动Nginx服务（端口80）

### 10.2 使用步骤

1. **下载 deploy.bat 到项目目录**：将 `deploy.bat` 文件放到 `D:\web_zwy\` 目录下

2. **执行一键部署**：右键 `deploy.bat` → "以管理员身份运行"

3. **等待脚本完成**：脚本会自动完成所有准备工作

4. **启动服务**：按脚本提示，开两个新命令行窗口：
   - 窗口1：启动后端服务
   - 窗口2：启动Nginx服务

5. **验证部署**：访问 http://10.13.33.52 确认系统正常

### 10.3 deploy.bat 脚本内容

```bat
@echo off
echo 开始部署ZWY项目管理系统...

echo 1. 构建前端...
cd /d D:\web_zwy\frontend
call npm install
call npm run build

echo 2. 复制静态文件...
xcopy /E /Y dist\* ..\backend\static\

echo 3. 安装后端依赖...
cd ..\backend
pip install -r requirements.txt

echo 4. 初始化数据库...
python init_db.py

echo 5. 配置防火墙...
netsh advfirewall firewall add rule name="Allow Port 80" dir=in action=allow protocol=TCP localport=80

echo.
echo ====================================================================
echo                    一键部署完成！
echo ====================================================================
echo.
echo 接下来需要手动启动两个服务：
echo.
echo 【第1步】启动后端服务 - 开新命令行窗口，复制执行：
echo cd /d D:\web_zwy\backend
echo uvicorn main:app --host 0.0.0.0 --port 8000
echo.
echo 【第2步】启动Nginx服务 - 再开新命令行窗口，复制执行：
echo cd /d D:\nginx-1.28.0
echo nginx.exe
echo.
echo ====================================================================
echo 启动完成后的访问地址：
echo 本机访问: http://localhost
echo 内网访问: http://10.13.33.52
echo 默认账号: admin / admin123
echo ====================================================================
echo.
pause
```

### 10.4 为什么不能完全一键？

**原因**：后端API服务和Nginx需要在前台持续运行，如果批处理脚本启动它们，脚本窗口关闭后服务也会自动停止。因此需要在独立的命令行窗口中手动启动这两个服务，确保它们能够持续运行。

### 10.5 服务管理

**启动服务后：**
- 保持两个命令行窗口开启状态
- 不要关闭这两个窗口，否则服务会停止
- 如需停止服务，在对应窗口按 `Ctrl+C`

**重启服务：**
- 后端服务：在后端窗口按 `Ctrl+C` 停止，然后重新运行 `uvicorn` 命令
- Nginx服务：在Nginx窗口按 `Ctrl+C`，或执行 `nginx.exe -s quit` 停止

---

## 11. 部署验证

**部署完成后验证：**
- **本机访问**: http://localhost
- **内网访问**: http://10.13.33.52  
- **默认账号**: admin / admin123

**成功标志：**
- 能正常打开登录页面
- 使用默认账号能成功登录
- 房间列表能正常加载显示